{% extends 'base.html' %}
{% load staticfiles %}
{% load crispy_forms_tags %}

{% block content %}

    <div id="donor_with_num_of_grants_data" style="display: none;">{{ donors }}</div>
    <div class="row">
        <div class="col-sm-2">
            <div class="panel panel-primary">
                <div class="panel-heading"><span class="glyphicon glyphicon-filter"> </span> Filter options </div>
                <div class="panel-body">
                    {% crispy form form.helper %}
                </div>
            </div>
        </div>
        <div class="col-sm-10">
            <div id='criteria-panel' class="panel panel-success" style="display: none;">
                <div class="panel-heading"> Filter Criteria </div>
                <div class="panel-body" id="criteria" style="display: block;"> No criteria specified </div>
            </div>
            <div id="donor_with_num_of_grants_chart"></div>
            <div id="donor_with_num_of_grants_table_div" class="table-responsive"> </div>
        </div>
    </div>


{% endblock content %}


{% block extra_js %}
<script type="text/javascript">
    "use strict";
    var drilldown_levels = [];


    // On the search form reset event, clear all of the select2 dorpdowns.
    $("body").on("reset", "#grants_donor_filter_form", function(e) {
        e.preventDefault();
        $("select#id_region").val('').trigger("change");
        $("select#id_country").val('').trigger("change");
        $("select#id_donor").val('').trigger("change");
        $("#id_submission_date_from").val('');
        $("#id_submission_date_to").val('');
        $("#id_grants_amount").val('');
        $("select#id_sector").val('').trigger("change");
        $("#id_subsector").val('').trigger("change");
        $("#id_theme").val('').trigger("change");
        $("#id_methodology").val('').trigger("change");
        $("#id_status").val('').trigger("change");
        //e.stopPropagation();
    });
    $(document).ready(function() {
    
        // Remove the hasDatePicker class so that the date-range works properly
        $( "#id_submission_date_from" ).removeClass("hasDatepicker");
        $( "#id_submission_date_to" ).removeClass("hasDatepicker");
    
        // Submission Date Range Picker 
        $( "#id_submission_date_from" ).datepicker({
            numberOfMonths: 1,
            dateFormat: 'yy-mm-dd',
            onClose: function( selectedDate ) {
                $( "#id_submission_date_to" ).datepicker( "option", "minDate", selectedDate );
            }
        });
        $( "#id_submission_date_to" ).datepicker({
            numberOfMonths: 1,
            dateFormat: 'yy-mm-dd',
            onClose: function( selectedDate ) {
                $( "#id_submission_date_from" ).datepicker( "option", "maxDate", selectedDate );
            }
        }); // End Submission Date Range Picker 


        // Upon search form submission, format filter values so Django understands it.
        $('#grants_donor_filter_form').on('submit', function(e) {
            e.preventDefault();
            var filters = {};
            $('#grants_donor_filter_form *').filter(':input').each(function() {
                if (this.name != 'submit' && this.name != 'reset' && this.value && this.name != '') {
                    var values_array = new Array($(this).val());
                    filters[this.name] = values_array.join(",");
                }
            });

            $('#donor_with_num_of_grants_data').empty();
            $.get("/global_dashboard_data/", filters)
                .done(function(data) {
                    if (Object.keys(data['donor_categories']).length > 0) {
                        $("#donor_with_num_of_grants_data").append(JSON.stringify(data));
                        var criteria = data['criteria'];
                        var formatted_criteria = format_criteria(criteria);
                        
                        //$("#criteria").html(JSON.stringify(formatted_criteria));
                        $("#criteria").html(formatted_criteria);
                        $("#criteria-panel").show();
                        draw_chart(criteria);
                    } else {
                        $("#donor_with_num_of_grants_chart").empty();
                        createAlert("warning dynamic-alert", "There is no data available for the specified criteria");
                    }
                });
        });
    });
    function format_criteria(criteria) {
        var formatted_criteria = '';
        $.each(criteria, function(key, value) {
            console.log(key + "=" + value);
            
            key = key.replace('__in', '=');
            key = key.replace('__gte', '>=');
            key = key.replace('__gt', '>');
            key = key.replace('__lt', '<');
            key = key.replace('_id', '');
            key = key.split("__");
            key = key[key.length - 1];
            console.log(key);
            switch (key) {
                case 'region=':
                    key = "Region=";
                    var values = $( "#id_region option:selected" ).map(function() {
                        return $(this).text();
                    }).get().join(', ');
                    value = values;
                    break;
                case 'country=':
                    key = "Country=";
                    var values = $( "#id_country option:selected" ).map(function() {
                        return $(this).text();
                    }).get().join(', ');
                    value = values;
                    //value = $( "#id_country option:selected" ).text();
                    break;
                case 'donor=':
                    key = "Donor=";
                    var values = $( "#id_donor option:selected" ).map(function() {
                        return $(this).text();
                    }).get().join(', ');
                    value = values;
                    break;
                case 'sector':
                    key =  "Sector=";
                    value = $("#id_sector option:selected").text();
                    break;
                case 'subsector':
                    key =  "Area of Focus=";
                    value = $( "#id_subsector option:selected" ).text();
                    break;
                case 'theme':
                    key =  "Theme=";
                    value = $( "#id_theme option:selected" ).text();
                    break;
                case 'methodology':
                    key = "Methodology=";
                    value = $( "#id_methodology option:selected" ).text();
                    break;
                case 'hq_admin':
                    key = "HQ Admin=";
                case 'submission_date>':
                    key = "Submission Date > ";
                    break;
                case 'submission_date<':
                    key = "Submission Date < ";
                    break;
                case 'amount_usd>=':
                    key = 'Amount USD >= ';
                    break;
                default:
                    break;
            }
            
            formatted_criteria += '<span class="label label-default" style="margin-left:2px; white-space:normal; line-height:2;">' + key + value + '</span>';
        });
        return formatted_criteria;
        
    }
    /*
     *  Show the corresponding table for the donor_with_num_grants chart
     */
    function show_donor_with_num_of_grants_table(drillupdown_data) {
        var donor_with_num_of_grants_table = new tableObject(drillupdown_data[0].data);
        $("#donor_with_num_of_grants_table_div").empty();
        $("#donor_with_num_of_grants_table_div").append(donor_with_num_of_grants_table);
        $("#donor_with_num_of_grants_table").DataTable();
    }

    /*
     * Draw the chart to visualize grants per donor or donor categories.
     */
    function draw_chart(filters) {
        var data_raw =  $("#donor_with_num_of_grants_data").html();
        var data = $.parseJSON(data_raw);
        var chart_title = '# Grants Per Donor Category'
        drilldown_levels = [];
        $('#donor_with_num_of_grants_chart').highcharts({
            credits: {
                text: 'mercycorps.org',
                href: 'http://www.mercycorps.org',
                enabled: false,
            },
            chart: {
                zoomType: 'x',
                panning: true,
                panKey: 'shift',
                resetZoomButton: {
                    position: {
                        // align: 'right', // by default
                        // verticalAlign: 'top', // by default
                        x: -10,
                        y: -25
                    }
                },
                type: 'column',
                margin: [80, 0, 90, 70],
                renderTo: 'donor_with_num_of_grants_chart',
                spacingBottom: 0,
                events: {
                    drilldown: function (e) {
                        var drilldown_data = $.grep(data['donors'], function(event){ return event.id == e.point.name; });
                        if (drilldown_data.length == 0) { // must be at the grants level of drilldown
                            //console.log(e.point.name + "  NOT FOUND!");
                            window.open('https://gait.mercycorps.org/editgrant.vm?GrantID=' + e.point.gait_id, '_blank');
                        } else if (drilldown_data.length == 1) {
                            show_donor_with_num_of_grants_table(drilldown_data);
                        } else {
                            createAlert("warning", "Found several objects with name: " + e.point.name);
                        }

                        if (this.series[0].name != 'Total USD Amount') {
                            var current_level = this.series[0].name + ' - <span style="color: red;">' + e.point.name + '</span>';
                            drilldown_levels.push(current_level);
                            this.setTitle({ text: current_level});
                        }
                    },
                    drillup: function(e) {
                        drilldown_levels.pop();
                        var name = drilldown_levels[drilldown_levels.length - 1 ];
                        if (name == undefined ) {
                            name = '# Grants per Donor Category';
                        }
                        this.setTitle({ text: name});

                        name = name.split('<span style="color: red;">');
                        if (name.length > 1) {
                            name = name[1].replace(/<\/span>$/, '');
                            var drillup_data = $.grep(data['donors'], function(event){ return event.id == name; });
                            show_donor_with_num_of_grants_table(drillup_data);
                        } else {
                            $("#donor_with_num_of_grants_table_div").empty();
                        }
                    },
                },
            },
            title: {
                text: chart_title
            },
            subtitle: {
                text: 'Source: <a href="https://gait.mercycorps.org" target="_blank">GAIT</a>'
            },
            xAxis: {
                type: 'category',
                labels: {
                    //rotation: -45,
                    style: {
                        fontSize: '10px',
                    }
                }
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Values',
                    align: 'high'
                }
            },
            plotOptions: {
                column: {
                    colorByPoint: true,
                },
                pointPadding: 0.2,
                groupPadding: 0,
                borderWidth: 1,
                series: {
                    allowPointSelect: true,
                    animation: {
                        duration: 1000
                    },
                    dataLabels: {
                        enabled: true,
                        align: 'top',
                        // rotation: -90,
                        //color: '#FFFFFF',
                        //y: -10
                    },
                },
            },
            
            tooltip: {
                backgroundColor: '#FCFFC5',
                //borderColor: 'black',
                borderRadius: 10,
                borderWidth: 1,
                shared: true,
                shadow: false,
                useHTML: true,
                style: {
                    padding: 5
                },
                headerFormat: '<small>{point.key}</small><table>',
                pointFormat: '<tr><td style="color: {series.color}">{series.name}: </td>' +
                    '<td style="text-align: right"><b>{point.y} </b></td></tr>',
                footerFormat: '</table>',
                /*
                formatter: function() {
                    //return '<b>' + this.point.name + '</b>, has <b>' + this.y + '</b> grants. <br /> '+ this.series.name;
                    return this.y;
                },
                */
            },
            legend: {
                enabled: false
            },
            series: [{
                type: 'pie',
                name: chart_title,
                data: data['donor_categories'],
            }],
            drilldown: {
                drillUpButton: {
                    relativeTo: 'spacingBox',
                    position: {
                        y: 20,
                        x: 0
                    },
                },
                series: data['donors']
            },
        });
    }

</script>
{% endblock %}