{% extends 'base.html' %}
{% load staticfiles %}
{% load crispy_forms_tags %}

{% block content %}

    <div id="donor_with_num_of_grants_data" style="display: none;">{{ donors }}</div>
    <div class="row">
        <div class="col-sm-2">
            <div class="panel panel-default">
                <div class="panel-heading">Filter options</div>
                <div class="panel-body">
                    {% crispy form form.helper %}
                </div>
            </div>
        </div>
        <div class="col-sm-10">
            <div id="donor_with_num_of_grants_chart"></div>
        </div>
    </div>

{% endblock content %}


{% block extra_js %}
<script type="text/javascript">

$(document).ready(function() {
    // Remove the hasDatePicker class so that the date-range works properly
    $( "#id_submission_date_from" ).removeClass("hasDatepicker");
    $( "#id_submission_date_to" ).removeClass("hasDatepicker");
    
    // Submission Date Range Picker 
    $( "#id_submission_date_from" ).datepicker({
        numberOfMonths: 1,
        dateFormat: 'yy-mm-dd',
        onClose: function( selectedDate ) {
            $( "#id_submission_date_to" ).datepicker( "option", "minDate", selectedDate );
        }
    });
    $( "#id_submission_date_to" ).datepicker({
        numberOfMonths: 1,
        dateFormat: 'yy-mm-dd',
        onClose: function( selectedDate ) {
            $( "#id_submission_date_from" ).datepicker( "option", "maxDate", selectedDate );
        }
    });
    // End Submission Date Range Picker 
    $('#grants_donor_filter_form').on('submit', function(e) {
        e.preventDefault();
        var filters = {};
        $('#grants_donor_filter_form *').filter(':input').each(function() {
            if (this.name != 'submit' && this.name != 'reset' && this.value) {
                filters[this.name] = this.value;
            }
        });
        

        $('#donor_with_num_of_grants_data').empty();
        //$.get("/api/v1/donors/", filters)
        //$.get("/api/v1/donorcategories/", filters)
        $.get("/z/", filters)
            .done(function(data) {
                if (Object.keys(data['donor_categories']).length > 0) {
                    $("#donor_with_num_of_grants_data").append(JSON.stringify(data));
                    draw_chart();
                } else {
                    $("#donor_with_num_of_grants_chart").empty();
                    createAlert("warning dynamic-alert", "There is no data available for the specified criteria");
                }
            });
    });

});

function draw_chart() {
    var data_raw =  $("#donor_with_num_of_grants_data").html();
    var data = $.parseJSON(data_raw);
    $('#donor_with_num_of_grants_chart').highcharts({
        chart: {
            zoomType: 'x',
            type: 'column',
            margin: [80, 0, 90, 60],
            renderTo: 'donor_with_num_of_grants_chart',
            spacingBottom: 0,
            events: {
                drilldown: function (e) {
                    console.log(e.point.grant_id);
                },
                click: function(e) {
                    console.log(e.xAxis[0].value + " : " + e.yAxis[0].value)
                },
            },
        },
        title: {
            text: 'Donors per Category'
        },
        subtitle: {
            text: 'Source: <a href="https://gait.mercycorps.org" target="_blank">Grant & Award Information Tracker</a>'
        },
        xAxis: {
            type: 'category',
            labels: {
                //rotation: -45,
                style: {
                    fontSize: '10px',
                    //fontFamily: 'Verdana, sans-serif'
                }
            }
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Number of Grants',
                align: 'high'
            }
        },
        plotOptions: {
            column: {
                colorByPoint: true,
            },
            pointPadding: 0.2,
            groupPadding: 0,
            borderWidth: 1,
            
            dataLabels: {
                enabled: true,
                align: 'top',
                rotation: -90,
                color: '#FFFFFF',
                y: -10
            },
            series: {
                allowPointSelect: true,
                animation: {
                    duration: 2000
                },
            },
        },
        tooltip: {
            backgroundColor: '#FCFFC5',
            //borderColor: 'black',
            borderRadius: 10,
            borderWidth: 1,
            //shared: true,
            shadow: false,
            useHTML: true,
            style: {
                padding: 10
            },
            //valueDecimals: 2,
            //valuePrefix: '$',
            //valueSuffix: ' USD',
            /*
            formatter: function() {
                //return '<b>' + this.point.name + '</b>, has <b>' + this.y + '</b> grants. <br /> '+ this.series.name;
                return this.y;
            },
            */
        },
        legend: {
            enabled: false
        },
        series: [{
            //type: 'pie',
            name: "Donors per Category",
            data: data['donor_categories'],
        }],
        drilldown: {
            series: data['donors']
        },
    });
}

</script>
{% endblock %}