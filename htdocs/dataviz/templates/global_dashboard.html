{% extends 'base.html' %}
{% load staticfiles %}
{% load crispy_forms_tags %}

{% block content %}
    <div class="panel panel-primary">
        <div class="panel-heading">Panel heading without title</div>
            <div class="panel-body">
                {% crispy form form.helper %}
            </div>
        </div>
    </div>
    <p>

</p>
 


    <div id="donor_with_num_of_grants_chart" style="width:100%; "></div>
    <div id="donor_with_num_of_grants_data" style="display: none;">{{ donors }}</div>
{% endblock content %}


{% block extra_js %}
<script type="text/javascript">

$(document).ready(function() {
    // Remove the hasDatePicker class so that the date-range works properly
    $( "#id_submission_date_from" ).removeClass("hasDatepicker");
    $( "#id_submission_date_to" ).removeClass("hasDatepicker");
    
    // Submission Date Range Picker 
    $( "#id_submission_date_from" ).datepicker({
        numberOfMonths: 1,
        dateFormat: 'yy-mm-dd',
        onClose: function( selectedDate ) {
            $( "#id_submission_date_to" ).datepicker( "option", "minDate", selectedDate );
        }
    });
    $( "#id_submission_date_to" ).datepicker({
        numberOfMonths: 1,
        dateFormat: 'yy-mm-dd',
        onClose: function( selectedDate ) {
            $( "#id_submission_date_from" ).datepicker( "option", "maxDate", selectedDate );
        }
    });
    // End Submission Date Range Picker 
    $('#grants_donor_filter_form').on('submit', function(e) {
        e.preventDefault();
        var filters = {};
        $('#grants_donor_filter_form *').filter(':input').each(function() {
            if (this.name != 'submit' && this.name != 'reset' && this.value) { 
                filters[this.name] = this.value;
            }
        });
        

        $('#donor_with_num_of_grants_data').empty();
        $.get("/api/v1/donors/", filters)
            .done(function(data) {
                if (data.length > 0 ) {
                    $("#donor_with_num_of_grants_data").append(JSON.stringify(data));
                    draw_chart();
                } else {
                    $("#donor_with_num_of_grants_chart").empty();
                    createAlert("warning dynamic-alert", "There is no data available for the specified criteria");
                }
            });
    });
    //draw_chart();
    
    $( "#slider-range" ).slider({
      range: true,
      min: 0,
      max: 601,
      values: [ 0, 100 ],
      slide: function( event, ui ) {
        $( "#amount" ).val( ui.values[ 0 ] + " - " + ui.values[ 1 ] );
      }
    });
    $( "#amount" ).val($( "#slider-range" ).slider( "values", 0 ) +
      " - " + $( "#slider-range" ).slider( "values", 1 ) );

});

function draw_chart(data) {
    var data =  $("#donor_with_num_of_grants_data").html();
    donors = $.parseJSON(data);
    var donor_names = [];
    var donor_grants = [];
    var i = 0;
    $.each(donors, function(k,v) {
        donor_names[i] = v.name;
        donor_grants[i] = v.grants_count;
        i++;
    });
    $('#donor_with_num_of_grants_chart').highcharts({
        chart: {
            type: 'column',
            renderTo: 'donor_with_num_of_grants_chart',
            spacingBottom: 0,
        },
        title: {
            text: 'Grants per Donor'
        },
        subtitle: {
            text: 'Source: <a href="https://gait.mercycorps.org" target="_blank">Grant & Award Information Tracker</a>'
        },
        xAxis: {
            categories: donor_names,
            title: {
                text: "Donors"
            }
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Number of Grants',
                align: 'high'
            }
        },
        plotOptions: {
            column: {
                pointPadding: 0.2,
                borderWidth: 0,
                dataLabels: {
                    enabled: true,
                }
            }
        },
        legend: {
            enabled: true
        },
        series: [
            {
                name: "Grants per Donor",
                colorByPoint: true,
                data: donor_grants
            }
        ]
    });
}

</script>
{% endblock %}